name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v3

      - name: EC2ì— SSH ì ‘ì† í›„ ë°°í¬
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
            cd ~/dangdang-check
            git pull origin main

            # í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆ í™•ì¸
            ACTIVE_VERSION=$(docker ps --format '{{.Names}}' | grep -E 'dangdang_check_app_blue|dangdang_check_app_green' || true)

            if [ -z "$ACTIVE_VERSION" ]; then
              echo "í˜„ìž¬ ì‹¤í–‰ ì¤‘ì¸ ì»¨í…Œì´ë„ˆê°€ ì—†ìŒ! Blue ì»¨í…Œì´ë„ˆë¥¼ ê¸°ë³¸ìœ¼ë¡œ ì‹¤í–‰í•©ë‹ˆë‹¤."
              docker-compose up --build -d app_blue

              echo "ìƒˆë¡œìš´ Blue ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
              for i in {1..10}; do
                sleep 3
                if docker ps --format '{{.Names}}' | grep -q "dangdang_check_app_blue"; then
                  echo "âœ… Blue ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë¨."
                  break
                fi
                echo "â³ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ëŒ€ê¸° ì¤‘..."
              done

              echo "ðŸ”„ Nginx ì„¤ì •ì„ Blueë¡œ ë³€ê²½"
              if [ -f /etc/nginx/conf.d/dangdang-check.conf ]; then
                sudo sed -i 's/127.0.0.1:8081 down;/127.0.0.1:8081 weight=1;/g' /etc/nginx/conf.d/dangdang-check.conf
                sudo sed -i 's/127.0.0.1:8082 weight=1;/127.0.0.1:8082 down;/g' /etc/nginx/conf.d/dangdang-check.conf
                sudo systemctl reload nginx
              else
                echo "âŒ Nginx ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                exit 1
              fi
              exit 0
            fi

            if [ "$ACTIVE_VERSION" == "dangdang_check_app_blue" ]; then
              echo "ðŸŸ¢ Blueê°€ í˜„ìž¬ í™œì„±í™”ë¨. Greenìœ¼ë¡œ ì „í™˜ ì¤‘..."
              docker-compose up --build -d app_green

              echo "ìƒˆë¡œìš´ Green ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
              for i in {1..10}; do
                sleep 3
                if docker ps --format '{{.Names}}' | grep -q "dangdang_check_app_green"; then
                  echo "âœ… Green ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë¨."
                  break
                fi
                echo "â³ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ëŒ€ê¸° ì¤‘..."
              done

              echo "ðŸ”„ íŠ¸ëž˜í”½ì„ Greenìœ¼ë¡œ ì „í™˜"
              if [ -f /etc/nginx/conf.d/dangdang-check.conf ]; then
                sudo sed -i 's/127.0.0.1:8081 weight=1;/127.0.0.1:8081 down;/g' /etc/nginx/conf.d/dangdang-check.conf
                sudo sed -i 's/127.0.0.1:8082 down;/127.0.0.1:8082 weight=1;/g' /etc/nginx/conf.d/dangdang-check.conf
                sudo systemctl reload nginx
              else
                echo "âŒ Nginx ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                exit 1
              fi

              echo "ðŸ›‘ ê¸°ì¡´ Blue ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ëŒ€ê¸° (30ì´ˆ)"
              sleep 30
              if docker ps -a --format '{{.Names}}' | grep -q 'dangdang_check_app_blue'; then
                docker stop dangdang_check_app_blue && docker rm dangdang_check_app_blue
              else
                echo "âš ï¸ dangdang_check_app_blue ì»¨í…Œì´ë„ˆê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŒ. ê±´ë„ˆëœ€."
              fi
            else
              echo "ðŸŸ¢ Greenì´ í˜„ìž¬ í™œì„±í™”ë¨. Blueë¡œ ì „í™˜ ì¤‘..."
              docker-compose up --build -d app_blue

              echo "ìƒˆë¡œìš´ Blue ì»¨í…Œì´ë„ˆ ìƒíƒœ í™•ì¸ ì¤‘..."
              for i in {1..10}; do
                sleep 3
                if docker ps --format '{{.Names}}' | grep -q "dangdang_check_app_blue"; then
                  echo "âœ… Blue ì»¨í…Œì´ë„ˆê°€ ì •ìƒì ìœ¼ë¡œ ì‹¤í–‰ë¨."
                  break
                fi
                echo "â³ ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ëŒ€ê¸° ì¤‘..."
              done

              echo "ðŸ”„ íŠ¸ëž˜í”½ì„ Blueë¡œ ì „í™˜"
              if [ -f /etc/nginx/conf.d/dangdang-check.conf ]; then
                sudo sed -i 's/127.0.0.1:8081 down;/127.0.0.1:8081 weight=1;/g' /etc/nginx/conf.d/dangdang-check.conf
                sudo sed -i 's/127.0.0.1:8082 weight=1;/127.0.0.1:8082 down;/g' /etc/nginx/conf.d/dangdang-check.conf
                sudo systemctl reload nginx
              else
                echo "âŒ Nginx ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤! ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
                exit 1
              fi

              echo "ðŸ›‘ ê¸°ì¡´ Green ì»¨í…Œì´ë„ˆ ì¢…ë£Œ ëŒ€ê¸° (30ì´ˆ)"
              sleep 30
              if docker ps -a --format '{{.Names}}' | grep -q 'dangdang_check_app_green'; then
                docker stop dangdang_check_app_green && docker rm dangdang_check_app_green
              else
                echo "âš ï¸ dangdang_check_app_green ì»¨í…Œì´ë„ˆê°€ ì¡´ìž¬í•˜ì§€ ì•ŠìŒ. ê±´ë„ˆëœ€."
              fi
            fi
          EOF
