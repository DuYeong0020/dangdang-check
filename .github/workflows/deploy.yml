name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: 코드 체크아웃
        uses: actions/checkout@v3

      - name: EC2에 SSH 접속 후 배포
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
          echo "$EC2_SSH_KEY" > private_key.pem
          chmod 600 private_key.pem

          ssh -o StrictHostKeyChecking=no -i private_key.pem $EC2_USER@$EC2_HOST << 'EOF'
            cd ~/dangdang-check
            git pull origin main

            # 현재 활성화된 컨테이너 확인
            ACTIVE_VERSION=$(docker ps --format '{{.Names}}' | grep dangdang_check_app_blue || true)

            if [ "$ACTIVE_VERSION" == "dangdang_check_app_blue" ]; then
              echo "Blue가 현재 활성화됨. Green으로 전환 중..."
              docker-compose up --build -d app_green

              echo "새로운 컨테이너 상태 확인 중..."
              for i in {1..10}; do
                sleep 3
                if docker ps | grep -q "dangdang_check_app_green"; then
                  echo "새 컨테이너가 정상적으로 실행됨."
                  break
                fi
                echo "컨테이너 실행 대기 중..."
              done

              echo "트래픽을 Green으로 전환"
              sed -i 's/127.0.0.1:8081 weight=1;/127.0.0.1:8081 weight=0;/g' /etc/nginx/conf.d/dangdang-check.conf
              sed -i 's/127.0.0.1:8082 weight=0;/127.0.0.1:8082 weight=1;/g' /etc/nginx/conf.d/dangdang-check.conf
              sudo systemctl reload nginx

              echo "기존 컨테이너 종료 대기 (30초)"
              sleep 30
              docker stop dangdang_check_app_blue && docker rm dangdang_check_app_blue
            else
              echo "Green이 현재 활성화됨. Blue로 전환 중..."
              docker-compose up --build -d app_blue

              echo "새로운 컨테이너 상태 확인 중..."
              for i in {1..10}; do
                sleep 3
                if docker ps | grep -q "dangdang_check_app_blue"; then
                  echo "새 컨테이너가 정상적으로 실행됨."
                  break
                fi
                echo "컨테이너 실행 대기 중..."
              done

              echo "트래픽을 Blue로 전환"
              sed -i 's/127.0.0.1:8081 weight=0;/127.0.0.1:8081 weight=1;/g' /etc/nginx/conf.d/dangdang-check.conf
              sed -i 's/127.0.0.1:8082 weight=1;/127.0.0.1:8082 weight=0;/g' /etc/nginx/conf.d/dangdang-check.conf
              sudo systemctl reload nginx

              echo "기존 컨테이너 종료 대기 (30초)"
              sleep 30
              docker stop dangdang_check_app_green && docker rm dangdang_check_app_green
            fi
          EOF
